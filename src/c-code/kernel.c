#include <stdio.h>
#include <string.h>
#include <multiboot2.h>
#include <mmap.h>
#include "heap.h"

const char ascii_data[] = {0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x20, 0x20, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x20, 0x0A, 0x20, 0x2F, 0x20, 0x5F, 0x20, 0x5C, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x28, 0x5F, 0x29, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x5F, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x7C, 0x0A, 0x2F, 0x20, 0x2F, 0x5F, 0x5C, 0x20, 0x5C, 0x20, 0x7C, 0x5F, 0x20, 0x5F, 0x5F, 0x20, 0x5F, 0x5F, 0x5F, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x20, 0x20, 0x5F, 0x20, 0x5F, 0x5F, 0x20, 0x5F, 0x20, 0x5F, 0x20, 0x5F, 0x5F, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x20, 0x5F, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x5C, 0x20, 0x60, 0x2D, 0x2D, 0x2E, 0x20, 0x0A, 0x7C, 0x20, 0x20, 0x5F, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x27, 0x5F, 0x20, 0x60, 0x20, 0x5F, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x5F, 0x20, 0x5C, 0x7C, 0x20, 0x27, 0x5F, 0x5F, 0x7C, 0x20, 0x7C, 0x20, 0x27, 0x5F, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x5F, 0x60, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x60, 0x2D, 0x2D, 0x2E, 0x20, 0x5C, 0x0A, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x28, 0x5F, 0x29, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x28, 0x5F, 0x7C, 0x20, 0x5C, 0x20, 0x5C, 0x5F, 0x2F, 0x20, 0x2F, 0x5C, 0x5F, 0x5F, 0x2F, 0x20, 0x2F, 0x0A, 0x5C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x2F, 0x5F, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x5C, 0x5F, 0x5F, 0x5F, 0x2F, 0x7C, 0x5F, 0x7C, 0x20, 0x20, 0x7C, 0x5F, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x5C, 0x5F, 0x5F, 0x2C, 0x5F, 0x7C, 0x5C, 0x5F, 0x5F, 0x5F, 0x2F, 0x5C, 0x5F, 0x5F, 0x5F, 0x5F, 0x2F, '\n', 0};

void shell_parse(const char* line, int n, char argv[5][20], int argc)
{
	uint8_t args_count = 0;
	char* start = line;
	char* end = line;

	do
	{
		end = strchr(start, ' ');
		if (end == 0)
		{
			strcpy(argv[args_count], start);
			break;
		}
		memcpy(argv[args_count], start, (int)(end-start));

		start = end+1;
	} while(args_count++ < argc);
}


void add(int n1, int n2)
{
	printf("%d\n", n1+n2);
}

void print(const char* format, char argv[5][20])
{
	int i = 0;
	int j = 2;
	while (format[i])
	{
		if (format[i] == '%')
		{
			if (format[i+1] == 'd')
				putd(atoi(argv[j++]));
			else if (format[i+1] == 'c')
				putc(argv[j++][0]);
			
			i+=2;
		}
		else
		{
			putc(format[i]);
			i++;
		}
   }
}

void help()
{
	puts("help - this list\n");
	puts("add - takes two numbers and adds. ex. add 1 2\n");
	puts("print - takes a format string a variables. ex. print hello%cworld @\n");
}

void shell()
{
	cls();

	char data[128] = "print hello%cworld @";
	char args[5][20] = {0};
	
	shell_parse(data, 128, args, 5);

	if (strcmp(args[0], "add") == 0)
	{
		add(atoi(args[1]), atoi(args[2]));
	}
	else if (strcmp(args[0], "print") == 0)
	{
		print(args[1], args);
	}
	else if (strcmp(args[0], "help") == 0)
		help();

	putc('\n');

}

void kernel_main(unsigned long magic, unsigned long addr) 
{
	initialize_idt64();
	cls();
	printf("Welcome to\n%s\n\n", ascii_data);

	/* Make sure the magic number matches for memory mapping*/
	if(magic != MULTIBOOT2_BOOTLOADER_MAGIC) {
		puts("invalid magic number!");
		return;
	}

	extract_mmap(addr);
	multiboot_memory_map_t* ent = get_mmap_entery(0);
	initialize_heap(ent->addr, ent->len);
	printf("Heap initialized. address: 0x%x, length: 0x%x\n", ent->addr, ent->len);

	char* str = (char*)malloc(10);
	memset(str, 0, 10);
	strcpy(str, "test str");

	printf("new string: %s\n", str);
}
